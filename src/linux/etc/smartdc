#!/usr/bin/env bash
#

. /lib/init/vars.sh

. /lib/lsb/init-functions

fatal() {
  echo "$@"
  exit 2
}

do_start() {
  # regenerate SSH keys if they're missing
  keycount=$(find /etc/ssh -name 'ssh_host_*_key*' | wc -l)
  if [[ $keycount -eq 0 ]] ; then 
    dpkg-reconfigure openssh-server
  fi
 
  local config='/etc/network/interfaces' 
  echo "#autogenerated by rc.local" > $config
  echo >> $config
  echo "auto lo" >> $config
  echo "iface lo inet loopback" >> $config
  echo >> $config
  
  interfaces=$(ifconfig -a | grep ^eth | awk '{print $1}')
  for i in ${interfaces[@]} ; do
    echo "auto $i" >> $config
    echo "iface $i inet dhcp" >> $config
    echo >> $config
    ifup $i
  done

  (/lib/smartdc/set-root-authorized-keys)
  (/lib/smartdc/format-secondary-disk)
  (/lib/smartdc/run-user-script)

  if [[ ! -d /var/lock/subsys ]] ; then
	  mkdir -p /var/lock/subsys
  fi
  touch /var/lock/subsys/local
}

do_stop() {
	exit 0
}

case "$1" in
  start|restart|reload|force-reload)
	  do_start
	  ;;
  stop)
	do_stop
	;;
  *)
	  echo "Usage: $SCRIPTNAME {start|stop|restart}" >&2
esac

